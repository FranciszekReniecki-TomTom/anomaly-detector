import { useState } from "react";
import { useDrawingTools } from "legoland-shared";

export function useMapView(filteredFeatures) {
  const [mapModel, setMapModel] = useState("Orbis");
  const [drawingOption, setDrawingOption] = useState();
  const [regions, setRegions] = useState([]);

  const { handleSelect: originalHandleSelect } = useDrawingTools(
    regions,
    setRegions
  );

  async function handleSelect(polygon) {
    originalHandleSelect(polygon);

    const formattedData = {
      startDay: "2025-01-01T00:00:00",
      endDay: "2025-01-07T23:59:59",
      coordinates: polygon.coordinates[0],
      dataType: "TOTAL_DISTANCE_M",
    };

    try {
      const response = await fetch("/api/polygons", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(formattedData),
      });

      if (!response.ok) {
        throw new Error(`Failed to send polygon data: ${response.statusText}`);
      }

      console.log("Polygon data sent successfully");
    } catch (error) {
      console.error(error);
    }
  }

  const anomalyLayer = {
    id: "anomalies",
    type: "fill",
    paint: { "fill-color": "#cc0000", "fill-opacity": 0.4 },
  };

  const regionLayer = {
    id: "regions",
    type: "fill",
    paint: {
      "fill-color": "green",
      "fill-outline-color": "green",
      "fill-opacity": 0.4,
    },
  };

  return {
    mapModel,
    setMapModel,
    drawingOption,
    setDrawingOption,
    regions,
    setRegions,
    handleSelect,
    anomalyLayer,
    regionLayer,
  };
}
